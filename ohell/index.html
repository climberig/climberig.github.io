<!DOCTYPE html>
<html lang="en">
<head>
    <title>Ohell</title>
    <link href='/images/favicon.ico' rel='shortcut icon' type='image/ico'>
</head>
<script>
    function ohell() {
        let inputParams = {players: [], dealerIdx: 0, cardLim: 0};//entered by user on the init page
        let gameState = {currCard: 1, roundCount: 1, dealerIdx: 0, scores: []};//mutable
        let allBidInputs = [], allTrickInputs = [];//keep all players bids and tricks for editing the scores
        document.getElementById('startButton').addEventListener("click", function () {
            let errors = validate();
            if (errors) alert(errors);
            else startGame(inputParams);
        });
        //document.getElementById('testButton').addEventListener("click", function () {startGame({players: ['igor', 'katie', 'emery'], dealerIdx: 0, cardLim: 2});});
        document.getElementById('editScoresLink').addEventListener("click", function () {
            toggle('editColumn');
        });

        function startGame(inputParams) {
            document.getElementById('updateButton').addEventListener("click", function () {
                document.getElementById('scoreTable').innerHTML = "";
                addRow('scoreTable', '', inputParams.players);
                let params = {currCard: 1, roundCount: 1, dealerIdx: inputParams.dealerIdx, scores: new Array(inputParams.players.length).fill(0)};
                for (let i = 0; i < allBidInputs.length; i++) {
                    addScores(allBidInputs[i], allTrickInputs[i], params);
                    nextRound(inputParams, params);
                }
                toggle('editColumn');
                run(inputParams, params);
            });
            document.getElementById('init').remove();
            toggle('game');
            addRow('editTable', '', inputParams.players);
            run(inputParams, gameState);
        }

        function run(inputParams, state) {
            if (state.currCard === 0) {
                showWinners(inputParams.players, state.scores);
                return;
            }
            if (state.currCard === 1 && state.roundCount === 1) {
                state.scores = new Array(inputParams.players.length).fill(0);
                state.dealerIdx = inputParams.dealerIdx;
                addRow('scoreTable', '', inputParams.players);
            }
            addCurrentPlayers(inputParams, state);
            let bidInputs = inputs('Bids', inputParams.players.length), trickInputs = [];
            for (let i = 0; i < bidInputs.length; i++)
                bidInputs[i].addEventListener("keyup", function () {
                    if (notNumber(bidInputs[i]))
                        return;
                    if (i < bidInputs.length - 1)
                        bidInputs[i + 1].focus();
                    if (i === bidInputs.length - 2) {
                        let diff = state.currCard - sumVals(bidInputs);
                        setMessage(diff >= 0 ? 'can not bid ' + diff : 'can bid everything');
                    } else if (i === bidInputs.length - 1) {
                        setMessage('');
                        if (trickInputs.length > 0) {
                            trickInputs[0].focus();
                            return;
                        }
                        trickInputs = inputs('Tricks', inputParams.players.length);
                        for (let i = 0; i < trickInputs.length; i++)
                            trickInputs[i].addEventListener("keyup", function () {
                                if (notNumber(trickInputs[i]))
                                    return
                                if (i < trickInputs.length - 1)
                                    trickInputs[i + 1].focus()
                                else if (i === trickInputs.length - 1) {
                                    document.getElementById('scoreTable').deleteRow(-1);//tricks inputs row
                                    document.getElementById('scoreTable').deleteRow(-1);//bids inputs row
                                    document.getElementById('scoreTable').deleteRow(-1);//current players
                                    saveForEdit(bidInputs, trickInputs, state);//bids and tricks inputs are cloned and saved to edit scores table *in initial player's order*
                                    addScores(allBidInputs[allBidInputs.length - 1], allTrickInputs[allBidInputs.length - 1], state);
                                    nextRound(inputParams, state);
                                    run(inputParams, state);
                                }
                            });
                    }
                });
        }

        function addCurrentPlayers(inputParams, params) {
            let currRoundPlayers = []
            for (let i = 0; i < inputParams.players.length; i++)
                currRoundPlayers.push(inputParams.players[(i + params.dealerIdx + 1) % inputParams.players.length])
            addRow('scoreTable', params.currCard, currRoundPlayers);
        }

        function nextRound(inputParams, params) {
            params.roundCount += 1;
            params.currCard += params.roundCount <= inputParams.cardLim ? 1 : -1;
            params.dealerIdx = (params.dealerIdx + 1) % inputParams.players.length;
        }

        function saveForEdit(bidInputs, trickInputs, state) {
            let newBidInputs = [], newTrickInputs = [];
            let row = document.getElementById('editTable').insertRow(-1);
            row.insertCell(-1);
            for (let i = 0; i < bidInputs.length; i++) {
                let idx = (i - state.dealerIdx - 1 + bidInputs.length) % bidInputs.length;
                let bidInput = newInput(bidInputs[idx].value), trickInput = newInput(trickInputs[idx].value);
                newBidInputs.push(bidInput);
                newTrickInputs.push(trickInput);
                let cell = row.insertCell(-1);
                cell.appendChild(bidInput);
                cell.appendChild(trickInput);
            }
            allBidInputs.push(newBidInputs);
            allTrickInputs.push(newTrickInputs);
        }

        function addScores(bidBoxes, trickBoxes, params) {
            for (let i = 0; i < bidBoxes.length; i++) {
                let bid = parseInt(bidBoxes[i].value), trick = parseInt(trickBoxes[i].value);
                let diff = Math.abs(bid - trick);
                let score = diff === 0 ? 10 + bid * 2 : -2 * diff;
                params.scores[i] += score;
            }
            addRow('scoreTable', params.currCard, params.scores);
        }

        function showWinners(players, scores) {
            let winners = [];
            let maxScore = Math.max(...scores);
            for (let i = 0; i < players.length; i++)
                if (scores[i] === maxScore)
                    winners.push(players[i]);
            setMessage(winners.join(',') + ' won');
        }

        function notNumber(box) {return box.value.trim() === '' || isNaN(box.value);}

        function setMessage(m) {document.getElementById('messages').innerHTML = m;}

        function inputs(label, len) {
            let inputs = new Array(len);
            for (let i = 0; i < len; i++)
                inputs[i] = newInput('');
            addRow('scoreTable', label, inputs);
            inputs[0].focus();
            return inputs;
        }

        function newInput(val) {
            let input = document.createElement('input');
            input.setAttribute("type", "text");
            input.value = val;
            return input;
        }

        function addRow(table, first, elements) {
            let row = document.getElementById(table).insertRow(-1);
            row.insertCell(-1).innerText = first;
            if (elements[0] instanceof HTMLElement)
                elements.forEach(v => row.insertCell(-1).appendChild(v));
            else elements.forEach(v => row.insertCell(-1).innerText = v);
        }

        function sumVals(inputs) {
            let sum = 0;
            for (let i = 0; i < inputs.length - 1; i++)
                sum += parseInt(inputs[i].value)
            return sum;
        }

        function toggle(id) {
            let html = document.getElementById(id);
            html.style.display = html.style.display === 'none' ? 'block' : 'none';
        }

        function validate() {
            let playersStr = document.getElementById('players').value.trim().toLowerCase();
            let dealerStr = document.getElementById('dealer').value.trim().toLowerCase();
            if (!playersStr || !dealerStr)
                return 'Enter players and dealer';
            if (playersStr.indexOf(dealerStr) === -1)
                return 'Dealer should be one of the players';
            let players = playersStr.split(',');
            for (let i = 0; i < players.length; i++) {
                players[i] = players[i].trim();
                if (players[i] === dealerStr)
                    inputParams.dealerIdx = i;
            }
            inputParams.cardLim = parseInt(document.getElementById('cardLim').value);
            inputParams.players = players;
        }
    }
</script>
<style>
    #scoreTable input, #scoreTable td {
        width: 40px;
        text-align: right;
    }

    #editTable input {
        width: 30px;
        text-align: right;
        float: right;
        height: 12px;
    }

    #editTable td {
        text-align: right;
    }
</style>
<body onload="ohell()">
<div id="init">
    <table>
        <tr>
            <td>Players</td>
            <td><input id="players" type="text" placeholder="igor,katie,emery"></td>
        </tr>
        <tr>
            <td>Dealer</td>
            <td><input id="dealer" type="text" placeholder="katie"></td>
        </tr>
        <tr>
            <td>Card Limit</td>
            <td><input id="cardLim" type="text" placeholder="13" pattern="\d*"></td>
        </tr>
    </table>
    <button id="startButton">Start Game</button>
<!--    <button id="testButton">Test Game</button>-->
    <p>Enter the names of the players as they are located around the table</p>
</div>
<div id="game" style="display: none">
    <table>
        <tr>
            <td>
                <table id="scoreTable"></table>
                <div id="messages" style="float: right"></div>
                <br/>
                <a id="editScoresLink" href="#">Edit Scores</a>
            </td>
            <td id="editColumn" style="display: none">
                <table id="editTable"></table>
                <button id="updateButton" style="float: right">Update</button>
            </td>
        </tr>
    </table>
</div>
</body>
</html>